<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة الضرائب والتأمينات المصرية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00f7;
            --dark-purple: #2a0e61;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(to bottom right, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
        }

        .neon-border {
            box-shadow: 0 0 5px var(--neon-blue),
                        0 0 10px var(--neon-blue),
                        0 0 20px var(--neon-blue);
            border: 2px solid var(--neon-blue);
        }

        .neon-text {
            text-shadow: 0 0 5px var(--neon-blue),
                         0 0 10px var(--neon-blue),
                         0 0 20px var(--neon-blue);
            color: var(--neon-blue);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
        }

        .input-3d {
            transform: perspective(1000px) rotateX(5deg);
            transition: transform 0.3s ease;
        }

        .input-3d:focus {
            transform: perspective(1000px) rotateX(0deg);
        }

        .result-card {
            transform: perspective(1000px) rotateY(5deg);
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: perspective(1000px) rotateY(0deg);
        }

        .tab-active {
            background: rgba(255, 255, 255, 0.2);
            border-bottom: 2px solid var(--neon-blue);
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-6xl font-bold neon-text mb-4">حاسبة الضرائب والتأمينات المصرية</h1>
            <p class="text-gray-300 text-xl">حساب الضرائب والتأمينات الاجتماعية وفقاً للقوانين المصرية</p>
        </header>

        <!-- Tabs -->
        <div class="flex justify-center mb-8">
            <button onclick="switchTab('tax')" id="taxTab" class="px-6 py-3 text-white rounded-t-lg tab-active">حاسبة الضرائب</button>
            <button onclick="switchTab('business')" id="businessTab" class="px-6 py-3 text-white rounded-t-lg">حاسبة أرباح الأعمال</button>
            <button onclick="switchTab('additional')" id="additionalTab" class="px-6 py-3 text-white rounded-t-lg">حاسبة الضريبة الإضافية</button>
            <button onclick="switchTab('late')" id="lateTab" class="px-6 py-3 text-white rounded-t-lg">حاسبة غرامات التأخير</button>
            <button onclick="switchTab('insurance')" id="insuranceTab" class="px-6 py-3 text-white rounded-t-lg">حاسبة التأمينات</button>
        </div>

        <!-- Main Content -->
        <div id="taxCalculator" class="grid md:grid-cols-2 gap-8">
            <!-- Input Form -->
            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">البيانات المطلوبة</h2>
                <form id="taxForm" class="space-y-6">
                    <!-- Entity Type -->
                    <div>
                        <label class="block text-white mb-2">نوع المنشأة</label>
                        <select id="entityType" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                            <option value="sole">منشأة فردية</option>
                            <option value="company">شركة</option>
                        </select>
                    </div>

                    <!-- Accounting Method -->
                    <div>
                        <label class="block text-white mb-2">طريقة المحاسبة</label>
                        <select id="accountingMethod" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                            <option value="netProfit">صافي الربح مباشرة</option>
                            <option value="calculate">حساب من المبيعات والمصروفات والإهلاك</option>
                            <option value="article3">المادة 3 من القانون 30 لسنة 2023</option>
                        </select>
                    </div>

                    <!-- Year Selection -->
                    <div>
                        <label class="block text-white mb-2">السنة</label>
                        <select id="taxYear" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                        </select>
                    </div>

                    <!-- Business Volume -->
                    <div>
                        <label class="block text-white mb-2">حجم الأعمال السنوي</label>
                        <input type="number" id="businessVolume" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل حجم الأعمال">
                    </div>

                    <!-- Net Profit Calculation Method -->
                    <div id="netProfitInput">
                        <div class="mb-4">
                            <label class="block text-white mb-2">طريقة حساب صافي الربح</label>
                            <select id="profitCalculationMethod" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                                <option value="direct">إدخال صافي الربح مباشرة</option>
                                <option value="percentage">حساب من حجم الأعمال والنسبة</option>
                            </select>
                        </div>

                        <!-- Direct Net Profit Input -->
                        <div id="directProfitInput">
                            <label class="block text-white mb-2">صافي الربح</label>
                            <input type="number" id="netProfit" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل صافي الربح">
                        </div>

                        <!-- Percentage Based Calculation (initially hidden) -->
                        <div id="percentageInput" class="hidden">
                            <div class="mb-4">
                                <label class="block text-white mb-2">نسبة صافي الربح من حجم الأعمال (%)</label>
                                <input type="number" id="profitPercentage" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل النسبة المئوية">
                            </div>
                            <div class="text-gray-400 text-sm">
                                صافي الربح المحسوب: <span id="calculatedProfit">0</span> جنيه
                            </div>
                        </div>
                    </div>

                    <!-- Sales and Expenses (initially hidden) -->
                    <div id="salesExpensesInputs" class="hidden space-y-4">
                        <div>
                            <label class="block text-white mb-2">المخزون أول المدة</label>
                            <input type="number" id="beginningInventory" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المخزون أول المدة">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المشتريات المحلية</label>
                            <input type="number" id="localPurchases" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المشتريات المحلية">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المشتريات المستوردة</label>
                            <input type="number" id="importPurchases" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المشتريات المستوردة">
                        </div>
                        <div>
                            <label class="block text-white mb-2">الجمارك</label>
                            <input type="number" id="customs" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل الجمارك">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المشتريات غير المصرح بها</label>
                            <input type="number" id="undeclaredPurchases" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المشتريات غير المصرح بها">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المخزون آخر المدة</label>
                            <input type="number" id="endingInventory" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المخزون آخر المدة">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المبيعات</label>
                            <input type="number" id="sales" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المبيعات">
                        </div>
                        <div>
                            <label class="block text-white mb-2">المصروفات</label>
                            <input type="number" id="expenses" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المصروفات">
                        </div>
                        <div>
                            <label class="block text-white mb-2">الإهلاك</label>
                            <input type="number" id="depreciation" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل الإهلاك">
                        </div>
                        <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg">
                            <div class="text-white">
                                <div class="mb-2">تكلفة المشتريات: <span id="purchaseCost">0</span> جنيه</div>
                                <div class="mb-2">إجمالي الربح: <span id="grossProfit">0</span> جنيه</div>
                                <div>صافي الربح: <span id="calculatedNetProfit">0</span> جنيه</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4" dir="ltr">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-blue-700 transition duration-300">
                            حساب الضرائب
                        </button>
                        <button type="reset" onclick="resetForm()" class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-red-700 transition duration-300">
                            إعادة تعيين
                        </button>
                    </div>
                </form>
            </section>

            <!-- Results Section -->
            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">النتائج</h2>
                <div class="space-y-4">
                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">ضريبة الدخل</h3>
                        <p id="incomeTaxResult" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">الإعفاء الضريبي</h3>
                        <p id="taxExemptionResult" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">صافي الضريبة المستحقة</h3>
                        <p id="netTaxResult" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <!-- Tax Brackets Display -->
                    <div id="taxBrackets" class="mt-6 glass-effect p-6 neon-border rounded-lg">
                        <h3 class="text-2xl font-bold text-white mb-4">شرائح الضريبة المطبقة</h3>
                        <!-- Tax brackets will be displayed here -->
                    </div>

                    <div class="flex space-x-4 mt-6" dir="ltr">
                        <button onclick="generatePDF()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-green-700 transition duration-300">
                            تحميل PDF
                        </button>
                        <button onclick="window.print()" class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-purple-700 transition duration-300">
                            طباعة
                        </button>
                    </div>
                </div>
            </section>
        </div>

            <!-- Business Earnings Calculator -->
            <div id="businessCalculator" class="grid md:grid-cols-2 gap-8 hidden">
                <section class="glass-effect p-4 neon-border">
                    <h2 class="text-2xl font-bold text-white mb-4">حاسبة أرباح الأعمال</h2>
                    <form id="businessForm" class="space-y-6" onsubmit="calculateBusinessEarnings(event)">
                        <!-- Period Type Selection -->
                        <div class="flex justify-between mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="periodType" value="monthly" checked class="form-radio text-blue-600">
                                <span class="ml-2 text-white">إدخال قيم شهرية</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="periodType" value="annual" class="form-radio text-blue-600">
                                <span class="ml-2 text-white">إدخال قيم سنوية</span>
                            </label>
                        </div>

                        <!-- Facility Type -->
                        <div>
                            <label class="block text-white mb-2">نوع المنشأة</label>
                            <select id="facilityType" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                                <option value="private">خاص</option>
                                <option value="government">حكومي</option>
                                <option value="public">قطاع عام</option>
                            </select>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h3 class="text-white text-lg mb-2">الأجر الشهري</h3>
                                <input type="number" id="monthlySalaryBusiness" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل الأجر الشهري" min="1" required>
                            </div>
                            <div>
                                <h3 class="text-white text-lg mb-2">الاشتراكات والخصومات</h3>
                                <input type="number" id="deductions" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل الاشتراكات والخصومات" value="0">
                                <div class="text-gray-400 text-xs mt-1">الاشتراكات، الخصومات، التخفيضات</div>
                            </div>
                            <div>
                                <h3 class="text-white text-lg mb-2">البدلات المعفاة (شهري)</h3>
                                <input type="number" id="exemptAllowances" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل البدلات المعفاة" value="0">
                                <div class="text-gray-400 text-xs mt-1">البدلات المعفاة من التأمين، بحد أقصى 30% من قيمة الاشتراك</div>
                            </div>
                        </div>

                    <!-- Insurance Options -->
                    <div class="flex items-center justify-between">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="calculateInsuranceBusiness" checked class="form-checkbox text-blue-600">
                            <span class="mr-2 text-white">حساب التأمين</span>
                        </label>
                        <button type="button" onclick="showInsuranceLimits()" class="text-blue-400 hover:text-blue-300 text-sm">
                            حدود التأمين القصوى والدنيا
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-4 mt-4">
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-blue-700 transition duration-300">
                            حساب الأرباح
                        </button>
                        <button type="reset" onclick="resetBusinessForm()" class="w-full bg-red-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-red-700 transition duration-300">
                            إعادة تعيين
                        </button>
                    </div>
                </form>
            </section>

            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">النتائج</h2>
                <div class="space-y-6">
                    <!-- Summary -->
                    <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-4">
                        <h3 class="text-xl font-bold text-white mb-4">الملخص</h3>
                        <div class="text-center text-white">
                            <p>الإجمالي (سنوي: <span id="annualTotal" class="font-bold text-blue-400">0</span>) (شهري: <span id="monthlyTotal" class="font-bold text-blue-400">0</span>)</p>
                        </div>
                    </div>

                    <!-- Monthly Breakdown -->
                    <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-4">التفاصيل الشهرية</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-white">
                                <thead>
                                    <tr class="text-gray-400">
                                        <th class="text-right p-2">الشهر</th>
                                        <th class="text-right p-2">الإعفاء الشخصي</th>
                                        <th class="text-right p-2">وعاء الضريبة</th>
                                        <th class="text-right p-2">الضريبة</th>
                                        <th class="text-right p-2">الصافي</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyBreakdown">
                                    <!-- Monthly rows will be added here dynamically -->
                                </tbody>
                                <tfoot class="border-t border-gray-600">
                                    <tr class="font-bold">
                                        <td class="p-2">الإجمالي</td>
                                        <td id="totalPersonalExemption" class="p-2">0</td>
                                        <td id="totalTaxBase" class="p-2">0</td>
                                        <td id="totalTax" class="p-2">0</td>
                                        <td id="totalNet" class="p-2">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Additional Tax Calculator -->
        <div id="additionalCalculator" class="grid md:grid-cols-2 gap-8 hidden">
            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">حساب فائدة فرق فحص ضريبة القيمة المضافة</h2>
                <form id="additionalTaxForm" class="space-y-6">
                    <!-- Tax Period -->
                    <div>
                        <label class="block text-white mb-2">الفترة الضريبية</label>
                        <input type="date" id="taxPeriod" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                    </div>

                    <!-- Amount -->
                    <div>
                        <label class="block text-white mb-2">المبلغ</label>
                        <input type="number" id="taxAmount" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المبلغ">
                    </div>

                    <!-- Notification Date -->
                    <div>
                        <label class="block text-white mb-2">تاريخ الإخطار من المأمورية</label>
                        <input type="date" id="notificationDate" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                    </div>

                    <!-- Payment Date -->
                    <div>
                        <label class="block text-white mb-2">تاريخ السداد</label>
                        <input type="date" id="paymentDate" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-blue-700 transition duration-300">
                        حساب الضريبة الإضافية
                    </button>
                </form>
            </section>

            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">النتائج</h2>
                <div class="space-y-6">
                    <!-- First Period Results -->
                    <div class="text-center">
                        <div class="alert bg-blue-900 bg-opacity-50 p-4 rounded-lg mb-4">
                            1.5% عن كل شهر، بحد أقصى 36 شهر (3 سنوات)
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-white">
                            <div>
                                <div>بداية الحساب</div>
                                <div id="calculationStart" class="font-bold">-</div>
                            </div>
                            <div>
                                <div>تاريخ الإخطار</div>
                                <div id="notificationDateResult" class="font-bold">-</div>
                            </div>
                            <div>
                                <div>عدد الشهور</div>
                                <div id="monthsCount1" class="font-bold">0</div>
                            </div>
                            <div>
                                <div>الغرامة</div>
                                <div id="penalty1" class="font-bold">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Second Period Results -->
                    <div class="text-center">
                        <hr class="my-4 border-gray-600">
                        <div class="alert bg-blue-900 bg-opacity-50 p-4 rounded-lg mb-4">
                            1.5% عن كل شهر من تاريخ الإخطار حتى تاريخ السداد
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-white">
                            <div>
                                <div>تاريخ الإخطار</div>
                                <div id="notificationDateResult2" class="font-bold">-</div>
                            </div>
                            <div>
                                <div>تاريخ السداد</div>
                                <div id="paymentDateResult" class="font-bold">-</div>
                            </div>
                            <div>
                                <div>عدد الشهور</div>
                                <div id="monthsCount2" class="font-bold">0</div>
                            </div>
                            <div>
                                <div>الغرامة</div>
                                <div id="penalty2" class="font-bold">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Results -->
                    <div class="text-center">
                        <hr class="my-4 border-gray-600">
                        <div class="grid grid-cols-4 text-white">
                            <div class="col-span-3"></div>
                            <div>
                                <div>الإجمالي</div>
                                <div id="totalPenalty" class="font-bold">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Late Fee Calculator -->
        <div id="lateCalculator" class="grid md:grid-cols-2 gap-8 hidden">
            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">حاسبة غرامات التأخير</h2>
                <form id="lateFeeForm" class="space-y-6">
                    <!-- Entity Type and Payment Date -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white mb-2">المنشأة</label>
                            <select id="lateEntityType" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                                <option value="individual">فرد</option>
                                <option value="company">شركة</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-white mb-2">تاريخ السداد النهائي</label>
                            <input type="date" id="finalPaymentDate" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                        </div>
                    </div>

                    <!-- Amount Field -->
                    <div>
                        <label class="block text-white mb-2">المبلغ المستحق</label>
                        <input type="number" id="lateFeeAmount" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل المبلغ المستحق">
                    </div>

                    <div class="flex justify-center pt-4">
                        <button type="button" onclick="addTaxDifference()" class="bg-blue-600 text-white px-4 py-2 rounded-lg neon-border hover:bg-blue-700 transition duration-300">
                            <i class="fas fa-plus"></i> إضافة فرق ضريبي
                        </button>
                    </div>

                    <div class="flex justify-center items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="excludeFractions" checked class="form-checkbox text-blue-600">
                            <span class="mr-2 text-white">استبعاد كسر الشهر والجنيه</span>
                        </label>
                    </div>
                </form>

                <!-- Instructions -->
                <div class="mt-8 text-center">
                    <p class="text-white mb-4">أضف فرق فحص الضريبة الصافي عن فترة ضريبية معينة أو عملية سداد.</p>
                    <div class="text-gray-300 text-sm space-y-2">
                        <p>- يتم حساب فائدة فرق الضريبة العام حتى تاريخ السداد النهائي</p>
                        <p>- يبدأ حساب الغرامة من 1 أبريل للأفراد و1 مايو للشركات</p>
                        <p>- يمكن إضافة أكثر من فرق ضريبي أو عملية سداد</p>
                        <p>- يتم استبعاد كسر الشهر والجنيه (طبقاً للقانون)</p>
                        <p>- عملية السداد تغطي فرق الضريبة أولاً ثم الغرامة</p>
                    </div>
                </div>
            </section>

            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">النتائج</h2>
                <div id="lateFeeResults" class="space-y-6">
                    <!-- Results will be dynamically added here -->
                    <div class="text-center text-white">
                        لا توجد فروق ضريبية مضافة بعد
                    </div>
                </div>
            </section>
        </div>

        <!-- Insurance Calculator (Initially Hidden) -->
        <div id="insuranceCalculator" class="grid md:grid-cols-2 gap-8 hidden">
            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">حساب التأمينات</h2>
                <form id="insuranceForm" class="space-y-6">
                    <!-- Sector Type -->
                    <div>
                        <label class="block text-white mb-2">نوع القطاع</label>
                        <select id="sectorType" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                            <option value="private">خاص</option>
                            <option value="government">حكومي</option>
                            <option value="public">قطاع عام</option>
                        </select>
                    </div>

                    <!-- Monthly Salary -->
                    <div>
                        <label class="block text-white mb-2">الراتب الشهري</label>
                        <input type="number" id="monthlySalary" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d" placeholder="أدخل الراتب الشهري">
                        <p class="text-gray-400 text-sm mt-1">الحد الأدنى: 1,400 جنيه - الحد الأقصى: 9,400 جنيه</p>
                    </div>

                    <!-- Year Selection -->
                    <div>
                        <label class="block text-white mb-2">السنة</label>
                        <select id="insuranceYear" class="w-full bg-gray-800 text-white p-3 rounded-lg input-3d">
                        </select>
                    </div>

                    <!-- Calculate Button -->
                    <button type="button" onclick="calculateInsurance()" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg neon-border hover:bg-blue-700 transition duration-300">
                        حساب التأمينات
                    </button>
                </form>
            </section>

            <section class="glass-effect p-6 neon-border">
                <h2 class="text-2xl font-bold text-white mb-6">نتائج التأمينات</h2>
                <div class="space-y-4">
                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">حصة الموظف الشهرية</h3>
                        <p id="employeeMonthlyShare" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">حصة الموظف السنوية</h3>
                        <p id="employeeAnnualShare" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">حصة الشركة الشهرية</h3>
                        <p id="companyMonthlyShare" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">حصة الشركة السنوية</h3>
                        <p id="companyAnnualShare" class="text-2xl neon-text">0 جنيه</p>
                    </div>

                    <div class="result-card glass-effect p-4">
                        <h3 class="text-white font-bold">إجمالي التأمينات</h3>
                        <p id="totalInsurance" class="text-2xl neon-text">0 جنيه</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 p-4 bg-gray-900 text-white text-center">
        <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
            <span>Designed by: Ahmed Mostafa Ibrahim</span>
            <span>📞 01225155329</span>
            <span>📧 a12345.mostafa@gmail.com</span>
        </div>
    </footer>

    <script>
        // Insurance Calculator Functions
        function calculateInsurance() {
            const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
            const sectorType = document.getElementById('sectorType').value;
            
            // Validate input
            if (!monthlySalary || monthlySalary <= 0) {
                document.getElementById('employeeMonthlyShare').textContent = '0 جنيه';
                document.getElementById('employeeAnnualShare').textContent = '0 جنيه';
                document.getElementById('companyMonthlyShare').textContent = '0 جنيه';
                document.getElementById('companyAnnualShare').textContent = '0 جنيه';
                document.getElementById('totalInsurance').textContent = '0 جنيه';
                return;
            }

            // Calculate employer and employee shares based on sector
            let employerRate;
            switch(sectorType) {
                case 'government':
                    employerRate = 0.1725; // 17.25% for government sector
                    break;
                case 'public':
                    employerRate = 0.1825; // 18.25% for public sector
                    break;
                default:
                    employerRate = 0.1875; // 18.75% for private sector
            }

            const employeeRate = 0.11; // 11% for employee
            
            // Apply salary limits (2025 rules)
            const minSalary = 2300; // New minimum from 2025
            const maxSalary = Math.round(minSalary * Math.pow(1.15, 4)); // 15% annual increase until 2029
            const insurableSalary = Math.min(Math.max(monthlySalary, minSalary), maxSalary);

            // Calculate monthly shares
            const employeeMonthly = insurableSalary * employeeRate;
            const employerMonthly = insurableSalary * employerRate;

            // Calculate annual values
            const employeeAnnual = employeeMonthly * 12;
            const employerAnnual = employerMonthly * 12;
            const totalAnnual = employeeAnnual + employerAnnual;

            // Update results
            document.getElementById('employeeMonthlyShare').textContent = Math.round(employeeMonthly).toLocaleString('ar-EG') + ' جنيه';
            document.getElementById('employeeAnnualShare').textContent = Math.round(employeeAnnual).toLocaleString('ar-EG') + ' جنيه';
            document.getElementById('companyMonthlyShare').textContent = Math.round(employerMonthly).toLocaleString('ar-EG') + ' جنيه';
            document.getElementById('companyAnnualShare').textContent = Math.round(employerAnnual).toLocaleString('ar-EG') + ' جنيه';
            document.getElementById('totalInsurance').textContent = Math.round(totalAnnual).toLocaleString('ar-EG') + ' جنيه';
        }
        // Initialize year dropdowns
        function initializeYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const yearDropdowns = ['taxYear', 'insuranceYear'];
            
            yearDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                for (let year = 1990; year <= 2050; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    dropdown.appendChild(option);
                }
            });
        }

        // Switch between calculators
        function switchTab(tab) {
            const calculators = {
                tax: 'taxCalculator',
                business: 'businessCalculator',
                additional: 'additionalCalculator',
                late: 'lateCalculator',
                insurance: 'insuranceCalculator'
            };
            
            // Hide all calculators
            Object.values(calculators).forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            const tabs = ['taxTab', 'businessTab', 'additionalTab', 'lateTab', 'insuranceTab'];
            tabs.forEach(id => {
                document.getElementById(id)?.classList.remove('tab-active');
            });
            
            // Show selected calculator and activate tab
            document.getElementById(calculators[tab])?.classList.remove('hidden');
            document.getElementById(tab + 'Tab')?.classList.add('tab-active');
        }

        // Toggle input fields based on calculation method
        document.getElementById('accountingMethod').addEventListener('change', function() {
            const netProfitInput = document.getElementById('netProfitInput');
            const salesExpensesInputs = document.getElementById('salesExpensesInputs');
            const profitCalculationMethod = document.getElementById('profitCalculationMethod');

            if (this.value === 'calculate') {
                netProfitInput.classList.add('hidden');
                salesExpensesInputs.classList.remove('hidden');
                calculatePurchaseCost();
            } else {
                netProfitInput.classList.remove('hidden');
                salesExpensesInputs.classList.add('hidden');
            }
        });

        // Toggle profit calculation method
        document.getElementById('profitCalculationMethod').addEventListener('change', function() {
            const directProfitInput = document.getElementById('directProfitInput');
            const percentageInput = document.getElementById('percentageInput');

            if (this.value === 'percentage') {
                directProfitInput.classList.add('hidden');
                percentageInput.classList.remove('hidden');
                calculateProfitFromPercentage();
            } else {
                directProfitInput.classList.remove('hidden');
                percentageInput.classList.add('hidden');
            }
        });

        // Calculate profit from percentage
        function calculateProfitFromPercentage() {
            const businessVolume = parseFloat(document.getElementById('businessVolume').value) || 0;
            const percentage = parseFloat(document.getElementById('profitPercentage').value) || 0;
            const calculatedProfit = businessVolume * (percentage / 100);
            document.getElementById('calculatedProfit').textContent = Math.round(calculatedProfit).toLocaleString('ar-EG');
            document.getElementById('netProfit').value = calculatedProfit;
        }

        // Add event listeners for real-time calculation
        document.getElementById('businessVolume').addEventListener('input', function() {
            if (document.getElementById('profitCalculationMethod').value === 'percentage') {
                calculateProfitFromPercentage();
            }
        });

        document.getElementById('profitPercentage').addEventListener('input', calculateProfitFromPercentage);

        // Calculate purchase cost and profits
        function calculatePurchaseCost() {
            const beginningInventory = parseFloat(document.getElementById('beginningInventory').value) || 0;
            const localPurchases = parseFloat(document.getElementById('localPurchases').value) || 0;
            const importPurchases = parseFloat(document.getElementById('importPurchases').value) || 0;
            const customs = parseFloat(document.getElementById('customs').value) || 0;
            const undeclaredPurchases = parseFloat(document.getElementById('undeclaredPurchases').value) || 0;
            const endingInventory = parseFloat(document.getElementById('endingInventory').value) || 0;
            const sales = parseFloat(document.getElementById('sales').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            const depreciation = parseFloat(document.getElementById('depreciation').value) || 0;

            // Calculate total purchase cost
            const purchaseCost = beginningInventory + localPurchases + importPurchases + 
                               customs + undeclaredPurchases - endingInventory;

            // Calculate gross profit
            const grossProfit = sales - purchaseCost;

            // Calculate net profit
            const netProfit = grossProfit - expenses + depreciation;

            // Update display
            document.getElementById('purchaseCost').textContent = Math.round(purchaseCost).toLocaleString('ar-EG');
            document.getElementById('grossProfit').textContent = Math.round(grossProfit).toLocaleString('ar-EG');
            document.getElementById('calculatedNetProfit').textContent = Math.round(netProfit).toLocaleString('ar-EG');
            document.getElementById('netProfit').value = netProfit;
        }

        // Add event listeners for real-time calculation
        const purchaseInputs = [
            'beginningInventory', 'localPurchases', 'importPurchases', 'customs',
            'undeclaredPurchases', 'endingInventory', 'sales', 'expenses', 'depreciation'
        ];

        purchaseInputs.forEach(inputId => {
            document.getElementById(inputId)?.addEventListener('input', calculatePurchaseCost);
        });

        // Calculate Article 3 Tax (Law No. 30 of 2023)
        function calculateArticle3Tax(turnover) {
            if (turnover < 250000) return 1000;
            if (turnover < 500000) return 2500;
            if (turnover < 1000000) return 5000;
            if (turnover < 2000000) return turnover * 0.005; // 0.5%
            if (turnover < 3000000) return turnover * 0.0075; // 0.75%
            if (turnover <= 10000000) return turnover * 0.01; // 1%
            return turnover * 0.01; // 1% for any amount above 10M
        }

        // Calculate Corporate Tax (Fixed 22.5%)
        function calculateCorporateTax(netProfit) {
            return netProfit * 0.225; // Fixed 22.5% rate for corporations, no exemptions
        }

        // Calculate Sole Proprietorship Tax with updated thresholds
        function calculateSoleProprietorshipTax(netProfit, businessVolume) {
            let tax = 0;
            let exemption = 0;

            // Apply exemption only if business volume is less than 600,000
            if (businessVolume <= 600000) {
                exemption = 40000; // Updated exemption amount
                netProfit = Math.max(0, netProfit - exemption);
            }

            // Calculate tax based on business volume brackets
            if (businessVolume <= 600000) {
                // Progressive tax calculation starting from 0%
                let remainingProfit = netProfit;
                
                if (remainingProfit <= 0) return { tax: 0, exemption };
                
                if (remainingProfit > 1000000) {
                    tax += (remainingProfit - 1000000) * 0.30;
                    remainingProfit = 1000000;
                }
                if (remainingProfit > 400000) {
                    tax += (remainingProfit - 400000) * 0.275;
                    remainingProfit = 400000;
                }
                if (remainingProfit > 200000) {
                    tax += (remainingProfit - 200000) * 0.25;
                    remainingProfit = 200000;
                }
                if (remainingProfit > 60000) {
                    tax += (remainingProfit - 60000) * 0.225;
                    remainingProfit = 60000;
                }
                if (remainingProfit > 45000) {
                    tax += (remainingProfit - 45000) * 0.20;
                    remainingProfit = 45000;
                }
                if (remainingProfit > 30000) {
                    tax += (remainingProfit - 30000) * 0.15;
                    remainingProfit = 30000;
                }
                if (remainingProfit > 20000) {
                    tax += (remainingProfit - 20000) * 0.10;
                }
            } else if (businessVolume <= 700000) {
                tax = netProfit * 0.10; // Start from 10%
            } else if (businessVolume <= 800000) {
                tax = netProfit * 0.15; // Start from 15%
            } else if (businessVolume <= 900000) {
                tax = netProfit * 0.20; // Start from 20%
            } else {
                tax = netProfit * 0.225; // Start from 22.5%
            }

            return { tax, exemption };
        }

        // Calculate Business Earnings Tax (Law No. 7 of 2024)
        function calculateBusinessEarnings(e) {
            e.preventDefault();
            try {
                const monthlySalary = parseFloat(document.getElementById('monthlySalaryBusiness').value) || 0;
                const deductions = parseFloat(document.getElementById('deductions').value) || 0;
                const calculateInsurance = document.getElementById('calculateInsuranceBusiness').checked;

                // Initialize monthly breakdown table
                const monthlyBreakdown = document.getElementById('monthlyBreakdown');
                monthlyBreakdown.innerHTML = '';

                // Monthly calculations
                const months = [];
                const personalExemption = 20000 / 12; // Monthly personal exemption
                let totalTax = 0;
                let totalNet = 0;
                let totalTaxBase = 0;

                for (let i = 0; i < 12; i++) {
                    const date = new Date(2024, i, 7);
                    
                    // Calculate insurance for this month
                    let monthlyInsurance = 0;
                    if (calculateInsurance) {
                        const minSalary = 2300; // New minimum from 2025
                        const maxSalary = Math.round(minSalary * Math.pow(1.15, 4)); // 15% annual increase until 2029
                        const insurableSalary = Math.min(Math.max(monthlySalary, minSalary), maxSalary);
                        monthlyInsurance = insurableSalary * 0.11;
                    }

                    // Calculate monthly tax base
                    const monthlyTotal = monthlyInsurance + deductions;
                    const taxBase = monthlySalary - monthlyTotal - personalExemption;
                    totalTaxBase += taxBase;

                    // Calculate monthly tax using 2024 brackets
                    let monthlyTax = calculateMonthlyTax(taxBase);
                    totalTax += monthlyTax;

                    // Calculate net amount
                    const netAmount = monthlySalary - monthlyTax - monthlyTotal;
                    totalNet += netAmount;

                    // Add row to table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                        <td class="p-2">${Math.round(personalExemption).toLocaleString('ar-EG')}</td>
                        <td class="p-2">${Math.round(taxBase).toLocaleString('ar-EG')}</td>
                        <td class="p-2">${Math.round(monthlyTax).toLocaleString('ar-EG')}</td>
                        <td class="p-2">${Math.round(netAmount).toLocaleString('ar-EG')}</td>
                    `;
                    monthlyBreakdown.appendChild(row);
                }

                // Update summary
                document.getElementById('monthlyTotal').textContent = Math.round(monthlySalary - (totalTax/12)).toLocaleString('ar-EG');
                document.getElementById('annualTotal').textContent = Math.round(monthlySalary * 12 - totalTax).toLocaleString('ar-EG');
                
                // Update totals
                document.getElementById('totalPersonalExemption').textContent = Math.round(personalExemption * 12).toLocaleString('ar-EG');
                document.getElementById('totalTaxBase').textContent = Math.round(totalTaxBase).toLocaleString('ar-EG');
                document.getElementById('totalTax').textContent = Math.round(totalTax).toLocaleString('ar-EG');
                document.getElementById('totalNet').textContent = Math.round(totalNet).toLocaleString('ar-EG');

            } catch (error) {
                console.error('Error in calculation:', error);
                alert('حدث خطأ في الحساب. يرجى التحقق من المدخلات');
            }
        }

        // Calculate Corporate Tax
        function calculateCorporateTax(netProfit) {
            return netProfit * 0.225; // Fixed 22.5% rate for corporations
        }

        // Tax Calculation Function
        function calculateTax() {
            try {
                const form = document.getElementById('taxForm');
                const entityType = document.getElementById('entityType').value;
                const accountingMethod = document.getElementById('accountingMethod').value;
                const businessVolume = parseFloat(document.getElementById('businessVolume').value) || 0;
                const profitCalculationMethod = document.getElementById('profitCalculationMethod').value;

                // Reset error messages
                document.querySelectorAll('.error-message').forEach(el => el.remove());

                let netProfit = 0;
                let tax = 0;
                let exemption = 0;
                let taxBrackets = '';

                // Calculate net profit based on selected method
                if (accountingMethod === 'calculate') {
                    const values = {
                        beginningInventory: parseFloat(document.getElementById('beginningInventory').value) || 0,
                        localPurchases: parseFloat(document.getElementById('localPurchases').value) || 0,
                        importPurchases: parseFloat(document.getElementById('importPurchases').value) || 0,
                        customs: parseFloat(document.getElementById('customs').value) || 0,
                        undeclaredPurchases: parseFloat(document.getElementById('undeclaredPurchases').value) || 0,
                        endingInventory: parseFloat(document.getElementById('endingInventory').value) || 0,
                        sales: parseFloat(document.getElementById('sales').value) || 0,
                        expenses: parseFloat(document.getElementById('expenses').value) || 0,
                        depreciation: parseFloat(document.getElementById('depreciation').value) || 0
                    };

                    // Calculate purchase cost
                    const purchaseCost = values.beginningInventory + values.localPurchases + values.importPurchases + 
                                       values.customs + values.undeclaredPurchases - values.endingInventory;

                    // Calculate gross profit
                    const grossProfit = values.sales - purchaseCost;

                    // Calculate net profit
                    netProfit = grossProfit - values.expenses + values.depreciation;

                    // Update purchase cost display
                    document.getElementById('purchaseCost').textContent = Math.round(purchaseCost).toLocaleString('ar-EG');
                    document.getElementById('grossProfit').textContent = Math.round(grossProfit).toLocaleString('ar-EG');
                    document.getElementById('calculatedNetProfit').textContent = Math.round(netProfit).toLocaleString('ar-EG');

                } else if (accountingMethod === 'netProfit') {
                    if (profitCalculationMethod === 'percentage') {
                        const percentage = parseFloat(document.getElementById('profitPercentage').value) || 0;
                        netProfit = businessVolume * (percentage / 100);
                        document.getElementById('calculatedProfit').textContent = Math.round(netProfit).toLocaleString('ar-EG');
                    } else {
                        netProfit = parseFloat(document.getElementById('netProfit').value) || 0;
                    }
                } else if (accountingMethod === 'article3') {
                    tax = calculateArticle3Tax(businessVolume);
                    taxBrackets = `
                        <div class="mt-4 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
                            <h4 class="text-white font-bold mb-2">شرائح ضريبة المادة 3:</h4>
                            <ul class="text-gray-300 text-sm space-y-1">
                                <li>حتى 250,000: 1,000 جنيه</li>
                                <li>حتى 500,000: 2,500 جنيه</li>
                                <li>حتى 1,000,000: 5,000 جنيه</li>
                                <li>حتى 2,000,000: 0.5%</li>
                                <li>حتى 3,000,000: 0.75%</li>
                                <li>حتى 10,000,000: 1%</li>
                                <li>أكثر من 10,000,000: 1%</li>
                            </ul>
                        </div>`;
                }

                // Validate inputs
                if (!businessVolume || businessVolume <= 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message bg-red-500 bg-opacity-50 text-white p-2 rounded mt-2';
                    errorDiv.textContent = 'يرجى إدخال حجم أعمال صحيح';
                    document.getElementById('taxForm').appendChild(errorDiv);
                    return;
                }

                // Calculate tax based on entity type and accounting method
                if (accountingMethod !== 'article3') {
                    if (netProfit <= 0 && accountingMethod !== 'article3') {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message bg-red-500 bg-opacity-50 text-white p-2 rounded mt-2';
                        errorDiv.textContent = 'يرجى إدخال صافي ربح صحيح';
                        document.getElementById('taxForm').appendChild(errorDiv);
                        return;
                    }

                    if (entityType === 'sole') {
                        const result = calculateSoleProprietorshipTax(netProfit, businessVolume);
                        tax = result.tax;
                        exemption = result.exemption;
                        
                        // Display tax brackets for sole proprietorship
                        taxBrackets = `
                            <div class="mt-4 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
                                <h4 class="text-white font-bold mb-2">شرائح الضريبة للمنشأة الفردية:</h4>
                                <p class="text-gray-300 mb-2">حجم الأعمال: ${businessVolume.toLocaleString('ar-EG')} جنيه</p>
                                <p class="text-gray-300 mb-2">الإعفاء: ${businessVolume <= 600000 ? '40,000' : '0'} جنيه</p>
                                <ul class="text-gray-300 text-sm space-y-1">
                                    ${businessVolume <= 600000 ? `
                                        <li>حتى 20,000: 0%</li>
                                        <li>من 20,000 إلى 30,000: 10%</li>
                                        <li>من 30,000 إلى 45,000: 15%</li>
                                        <li>من 45,000 إلى 60,000: 20%</li>
                                        <li>من 60,000 إلى 200,000: 22.5%</li>
                                        <li>من 200,000 إلى 400,000: 25%</li>
                                        <li>من 400,000 إلى 1,000,000: 27.5%</li>
                                        <li>أكثر من 1,000,000: 30%</li>
                                    ` : `
                                        <li>يبدأ من ${
                                            businessVolume <= 700000 ? '10%' :
                                            businessVolume <= 800000 ? '15%' :
                                            businessVolume <= 900000 ? '20%' : '22.5%'
                                        }</li>
                                    `}
                                </ul>
                            </div>`;
                    } else {
                        tax = calculateCorporateTax(netProfit);
                        taxBrackets = `
                            <div class="mt-4 p-4 bg-gray-800 bg-opacity-50 rounded-lg">
                                <h4 class="text-white font-bold mb-2">ضريبة الشركات:</h4>
                                <p class="text-gray-300">معدل ثابت: 22.5% من صافي الربح</p>
                            </div>`;
                    }
                }

                // Update results with animation
                const elements = [
                    { id: 'incomeTaxResult', value: tax },
                    { id: 'taxExemptionResult', value: exemption },
                    { id: 'netTaxResult', value: tax - exemption }
                ];

                elements.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.transition = 'all 0.5s ease-out';
                        element.style.transform = 'scale(1.1)';
                        element.textContent = Math.round(value).toLocaleString('ar-EG') + ' جنيه';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 500);
                    }
                });

                // Display tax brackets
                const taxBracketsContainer = document.getElementById('taxBrackets');
                if (taxBracketsContainer) {
                    taxBracketsContainer.innerHTML = taxBrackets;
                }

            } catch (error) {
                console.error('Error calculating tax:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message bg-red-500 bg-opacity-50 text-white p-2 rounded mt-2';
                errorDiv.textContent = 'حدث خطأ في الحساب. يرجى التحقق من المدخلات';
                document.getElementById('taxForm').appendChild(errorDiv);
            }
        }

        // Insurance Calculation Function
        function calculateInsurance() {
            try {
                const monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 0;
                
                if (monthlySalary <= 0) {
                    alert('يرجى إدخال راتب شهري صحيح');
                    return;
                }

                // Calculate shares
                const employeeMonthly = monthlySalary * 0.11; // 11% employee share
                const companyMonthly = monthlySalary * 0.185; // 18.5% company share
                const employeeAnnual = employeeMonthly * 12;
                const companyAnnual = companyMonthly * 12;
                const total = (employeeMonthly + companyMonthly) * 12;

                // Update results with animation
                const elements = [
                    { id: 'employeeMonthlyShare', value: employeeMonthly },
                    { id: 'employeeAnnualShare', value: employeeAnnual },
                    { id: 'companyMonthlyShare', value: companyMonthly },
                    { id: 'companyAnnualShare', value: companyAnnual },
                    { id: 'totalInsurance', value: total }
                ];

                elements.forEach(({ id, value }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.transition = 'all 0.5s ease-out';
                        element.style.transform = 'scale(1.1)';
                        element.textContent = Math.round(value).toLocaleString('ar-EG') + ' جنيه';
                        
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 500);
                    }
                });

                // Scroll to results
                document.querySelector('.result-card').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });

            } catch (error) {
                console.error('Error calculating insurance:', error);
                alert('حدث خطأ في حساب التأمينات. يرجى التحقق من المدخلات');
            }
        }

        // Generate PDF Report
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4', true); // Enable RTL support
            
            // Set RTL
            doc.setR2L(true);
            
            // Add content to PDF
            doc.addFont('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap', 'Cairo', 'normal');
            doc.setFont('Cairo');
            doc.setFontSize(24);
            doc.text('تقرير الضرائب والتأمينات المصرية', 150, 20, { align: 'right' });
            
            // Add current date
            const date = new Date().toLocaleDateString('ar-EG');
            doc.setFontSize(12);
            doc.text('تاريخ التقرير: ' + date, 150, 30, { align: 'right' });
            
            // Add tax results
            doc.setFontSize(16);
            doc.text('نتائج حساب الضرائب:', 150, 45, { align: 'right' });
            doc.setFontSize(14);
            
            const taxResults = [
                ['ضريبة الدخل:', document.getElementById('incomeTaxResult').textContent],
                ['الإعفاء الضريبي:', document.getElementById('taxExemptionResult').textContent],
                ['صافي الضريبة:', document.getElementById('netTaxResult').textContent]
            ];
            
            let yPos = 55;
            taxResults.forEach(result => {
                doc.text(result[0], 150, yPos, { align: 'right' });
                doc.text(result[1], 80, yPos, { align: 'right' });
                yPos += 10;
            });
            
            // Add insurance results if available
            if (document.getElementById('employeeMonthlyShare').textContent !== '0 جنيه') {
                doc.setFontSize(16);
                doc.text('نتائج حساب التأمينات:', 150, yPos + 10, { align: 'right' });
                doc.setFontSize(14);
                
                const insuranceResults = [
                    ['حصة الموظف الشهرية:', document.getElementById('employeeMonthlyShare').textContent],
                    ['حصة الموظف السنوية:', document.getElementById('employeeAnnualShare').textContent],
                    ['حصة الشركة الشهرية:', document.getElementById('companyMonthlyShare').textContent],
                    ['حصة الشركة السنوية:', document.getElementById('companyAnnualShare').textContent],
                    ['إجمالي التأمينات:', document.getElementById('totalInsurance').textContent]
                ];
                
                yPos += 20;
                insuranceResults.forEach(result => {
                    doc.text(result[0], 150, yPos, { align: 'right' });
                    doc.text(result[1], 80, yPos, { align: 'right' });
                    yPos += 10;
                });
            }
            
            // Add footer
            doc.setFontSize(10);
            doc.text('تم إنشاء هذا التقرير بواسطة حاسبة الضرائب والتأمينات المصرية', 150, 280, { align: 'right' });
            
            // Save the PDF
            doc.save('تقرير-الضرائب-والتأمينات.pdf');
        }

        // Reset form and results
        function resetForm() {
            const elements = ['incomeTaxResult', 'taxExemptionResult', 'netTaxResult'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '0 جنيه';
                }
            });
            document.getElementById('taxForm').reset();
        }

        // Calculate Monthly Tax according to Law No. 7 of 2024
        function calculateMonthlyTax(monthlyIncome) {
            if (monthlyIncome <= 0) return 0;
            
            let tax = 0;
            let taxableIncome = monthlyIncome;

            // Progressive tax brackets for monthly income (Law No. 7 of 2024)
            if (taxableIncome > 83333.33) { // 1,000,000 / 12
                tax += (taxableIncome - 83333.33) * 0.30;
                taxableIncome = 83333.33;
            }
            if (taxableIncome > 33333.33) { // 400,000 / 12
                tax += (taxableIncome - 33333.33) * 0.275;
                taxableIncome = 33333.33;
            }
            if (taxableIncome > 16666.67) { // 200,000 / 12
                tax += (taxableIncome - 16666.67) * 0.25;
                taxableIncome = 16666.67;
            }
            if (taxableIncome > 5000) { // 60,000 / 12
                tax += (taxableIncome - 5000) * 0.225;
                taxableIncome = 5000;
            }
            if (taxableIncome > 3750) { // 45,000 / 12
                tax += (taxableIncome - 3750) * 0.20;
                taxableIncome = 3750;
            }
            if (taxableIncome > 2500) { // 30,000 / 12
                tax += (taxableIncome - 2500) * 0.15;
                taxableIncome = 2500;
            }
            if (taxableIncome > 1666.67) { // 20,000 / 12
                tax += (taxableIncome - 1666.67) * 0.10;
            }

            return tax;
        }

        // Business Earnings Calculator
        function calculateBusinessEarnings(e) {
            e.preventDefault();
            try {
                const salary = parseFloat(document.getElementById('monthlySalaryBusiness').value) || 0;
                const deductions = parseFloat(document.getElementById('deductions').value) || 0;
                const calculateInsurance = document.getElementById('calculateInsuranceBusiness').checked;

                // Calculate insurance based on salary limits
                let monthlyInsurance = 0;
                if (calculateInsurance) {
                    const minSalary = 1400;
                    const maxSalary = 9400;
                    const insurableSalary = Math.min(Math.max(salary, minSalary), maxSalary);
                    monthlyInsurance = insurableSalary * 0.11; // 11% insurance
                }

                // Monthly calculations
                const monthlyTotal = monthlyInsurance + deductions;
                const monthlyNet = salary - monthlyTotal;

                // Annual calculations
                const annualSalary = salary * 12;
                const annualInsurance = monthlyInsurance * 12;
                const annualDeductions = deductions * 12;
                const annualTotal = monthlyTotal * 12;
                const annualNet = monthlyNet * 12;

                // Personal exemption and tax calculations
                const personalExemption = 20000; // Annual personal exemption
                const taxableIncome = Math.max(0, annualNet - personalExemption);
                const tax = calculateTaxAmount(taxableIncome);
                const netAfterTax = annualNet - tax;

                // Update results with animation
                const elements = {
                    monthlyInsurance: monthlyInsurance,
                    monthlyDeductions: deductions,
                    monthlyTotal: monthlyTotal,
                    annualInsurance: annualInsurance,
                    annualDeductions: annualDeductions,
                    annualTotal: annualTotal,
                    totalPersonalExemption: personalExemption,
                    totalTaxBase: taxableIncome,
                    totalTax: tax,
                    totalNet: netAfterTax
                };

                // Update each element with animation
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.transition = 'all 0.3s ease-out';
                        element.style.transform = 'scale(1.1)';
                        element.textContent = Math.round(value).toLocaleString('ar-EG');
                        
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 300);
                    }
                });

            } catch (error) {
                console.error('Error in calculation:', error);
                alert('حدث خطأ في الحساب. يرجى التحقق من المدخلات');
            }
        }

        // Reset Business Form
        function resetBusinessForm() {
            const elements = [
                'monthlyInsurance', 'monthlyDeductions', 'monthlyTotal',
                'annualInsurance', 'annualDeductions', 'annualTotal',
                'totalPersonalExemption', 'totalTaxBase', 'totalTax', 'totalNet'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '0';
                }
            });
        }

        // Additional Tax Calculator
        function calculateAdditionalTax(e) {
            e?.preventDefault();
            const taxPeriod = new Date(document.getElementById('taxPeriod').value);
            const amount = parseFloat(document.getElementById('taxAmount').value) || 0;
            const notificationDate = new Date(document.getElementById('notificationDate').value);
            const paymentDate = new Date(document.getElementById('paymentDate').value);

            // Calculate first period (up to 36 months)
            const calculationStart = new Date(taxPeriod);
            calculationStart.setMonth(calculationStart.getMonth() + 3); // Start from 3 months after tax period
            const months1 = Math.min(36, monthsDifference(calculationStart, notificationDate));
            const penalty1 = amount * (0.015 * months1); // 1.5% per month

            // Calculate second period
            const months2 = monthsDifference(notificationDate, paymentDate);
            const penalty2 = amount * (0.015 * months2); // 1.5% per month

            // Update results
            updateAdditionalTaxResults({
                calculationStart,
                notificationDate,
                paymentDate,
                months1,
                months2,
                penalty1,
                penalty2,
                total: penalty1 + penalty2
            });
        }

        // Late Fee Calculator
        function calculateLateFee(e) {
            e?.preventDefault();
            const entityType = document.getElementById('lateEntityType').value;
            const finalPaymentDate = new Date(document.getElementById('finalPaymentDate').value);
            const amount = parseFloat(document.getElementById('lateFeeAmount').value) || 0;
            const excludeFractions = document.getElementById('excludeFractions').checked;

            if (amount <= 0) {
                alert('يرجى إدخال مبلغ صحيح');
                return;
            }

            // Calculate late fees based on entity type
            const startDate = new Date(finalPaymentDate.getFullYear(), entityType === 'individual' ? 3 : 4, 1); // April 1 or May 1
            const months = monthsDifference(startDate, finalPaymentDate);
            const monthCount = excludeFractions ? Math.floor(months) : months;
            
            // Calculate late fee (2% per month)
            const lateFee = amount * (0.02 * monthCount);

            // Update results
            const results = document.getElementById('lateFeeResults');
            results.innerHTML = `
                <div class="text-center text-white">
                    <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg mb-4">
                        <h3 class="text-xl font-bold mb-4">نتائج حساب غرامات التأخير</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-400">المبلغ الأصلي</p>
                                <p class="text-2xl font-bold text-blue-400 neon-text">${Math.round(amount).toLocaleString('ar-EG')} جنيه</p>
                            </div>
                            <div>
                                <p class="text-gray-400">عدد الشهور</p>
                                <p class="text-2xl font-bold text-blue-400 neon-text">${monthCount}</p>
                            </div>
                            <div>
                                <p class="text-gray-400">غرامة التأخير</p>
                                <p class="text-2xl font-bold text-blue-400 neon-text">${Math.round(lateFee).toLocaleString('ar-EG')} جنيه</p>
                            </div>
                            <div>
                                <p class="text-gray-400">إجمالي المستحق</p>
                                <p class="text-2xl font-bold text-blue-400 neon-text">${Math.round(amount + lateFee).toLocaleString('ar-EG')} جنيه</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to calculate months difference
        function monthsDifference(date1, date2) {
            const months = (date2.getFullYear() - date1.getFullYear()) * 12;
            return months + date2.getMonth() - date1.getMonth();
        }

        // Update Business Results
        function updateBusinessResults(results) {
            const elements = {
                monthlyInsurance: results.monthlyInsurance,
                monthlyDeductions: results.monthlyDeductions,
                monthlyTotal: results.monthlyTotal,
                annualInsurance: results.annualInsurance,
                annualDeductions: results.annualDeductions,
                annualTotal: results.annualTotal,
                totalPersonalExemption: results.personalExemption,
                totalTaxBase: results.taxBase,
                totalTax: results.tax,
                totalNet: results.net
            };

            for (const [id, value] of Object.entries(elements)) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = Math.round(value).toLocaleString('ar-EG');
                }
            }

            // Update total labels
            document.getElementById('annualTotalLabel').textContent = `(سنوي: ${Math.round(results.annualTotal).toLocaleString('ar-EG')})`;
            document.getElementById('monthlyTotalLabel').textContent = `(شهري: ${Math.round(results.monthlyTotal).toLocaleString('ar-EG')})`;
        }

        // Update Additional Tax Results
        function updateAdditionalTaxResults(results) {
            document.getElementById('calculationStart').textContent = results.calculationStart.toLocaleDateString('ar-EG');
            document.getElementById('notificationDateResult').textContent = results.notificationDate.toLocaleDateString('ar-EG');
            document.getElementById('notificationDateResult2').textContent = results.notificationDate.toLocaleDateString('ar-EG');
            document.getElementById('paymentDateResult').textContent = results.paymentDate.toLocaleDateString('ar-EG');
            document.getElementById('monthsCount1').textContent = results.months1;
            document.getElementById('monthsCount2').textContent = results.months2;
            document.getElementById('penalty1').textContent = Math.round(results.penalty1).toLocaleString('ar-EG');
            document.getElementById('penalty2').textContent = Math.round(results.penalty2).toLocaleString('ar-EG');
            document.getElementById('totalPenalty').textContent = Math.round(results.total).toLocaleString('ar-EG');
        }

        // Show Insurance Limits Modal
        function showInsuranceLimits() {
            alert('الحد الأدنى: 1400 جنيه\nالحد الأقصى: 9400 جنيه');
        }

        // Add Tax Difference Modal
        function addTaxDifference() {
            const html = `
                <div class="tax-difference-entry glass-effect p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white mb-2">المبلغ</label>
                            <input type="number" class="w-full bg-gray-800 text-white p-2 rounded-lg" placeholder="أدخل المبلغ">
                        </div>
                        <div>
                            <label class="block text-white mb-2">تاريخ الفترة</label>
                            <input type="date" class="w-full bg-gray-800 text-white p-2 rounded-lg">
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" class="mt-2 text-red-500 hover:text-red-400">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            `;
            
            const results = document.getElementById('lateFeeResults');
            if (results.firstElementChild.textContent.includes('لا توجد')) {
                results.innerHTML = '';
            }
            results.insertAdjacentHTML('beforeend', html);
        }

        // Initialize and add event listeners
        window.addEventListener('load', function() {
            initializeYearDropdowns();
            
            // Add form submit handlers
            document.getElementById('taxForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                calculateTax();
            });
            document.getElementById('businessForm')?.addEventListener('submit', calculateBusinessEarnings);
            document.getElementById('additionalTaxForm')?.addEventListener('submit', calculateAdditionalTax);
            document.getElementById('lateFeeForm')?.addEventListener('submit', calculateLateFee);

            // Add input change handlers for tax calculation
            const taxInputs = [
                'entityType', 'accountingMethod', 'businessVolume', 'netProfit',
                'profitCalculationMethod', 'profitPercentage',
                'beginningInventory', 'localPurchases', 'importPurchases',
                'customs', 'undeclaredPurchases', 'endingInventory',
                'sales', 'expenses', 'depreciation'
            ];

            taxInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', calculateTax);
                    element.addEventListener('change', calculateTax);
                }
            });

            // Add period type change handler
            document.querySelectorAll('input[name="periodType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isMonthly = this.value === 'monthly';
                    document.getElementById('monthlySalaryBusiness').placeholder = 
                        isMonthly ? 'أدخل الأجر الشهري' : 'أدخل الأجر السنوي';
                });
            });

            // Initial calculation
            calculateTax();
        });
    </script>
</body>
</html>
